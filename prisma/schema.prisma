generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  password      String?
  image         String?
  phone         String?
  role          Role      @default(CLIENT) // ADMIN, CAREGIVER, or CLIENT (not multiple)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  accounts      Account[]
  sessions      Session[]

  // Pipeline tracking
  conversionStage ClientConversionStage @default(PROSPECT)
  inquiryDate     DateTime?
  clientConvertedAt DateTime?

  // Only for CAREGIVER role
  caregiverProfile    CaregiverProfile?
  patientsAsCaregiver PatientCaregiverAssignment[] @relation("CaregiverToPatient")

  // Only for CLIENT role - family member relationships to patients
  familyMemberAssignments FamilyMemberAssignment[]

  // Bookings created by/associated with this user
  bookings Booking[]
  inquiries Inquiry[]

  @@map("users")
}

model PasswordResetToken {
 id                String   @id @default(cuid())
 token             String   @unique
 email             String
 expiresAt         DateTime 
 isUsed            Boolean  @default(false)
 createdAt         DateTime @default(now())

 @@map("password_reset_tokens")
}

// Inquiry model captures initial contact/lead before booking
model Inquiry {
  id                String        @id @default(cuid())
  userId            String
  name              String
  email             String
  phone             String?
  inquirySource     String?       // "website_form", "email", "referral", "phone", etc.
  subject           String?
  message           String?
  status            InquiryStatus @default(NEW)
  qualifiedAt       DateTime?
  disqualifiedAt    DateTime?
  disqualificationReason String?
  convertedToBookingAt DateTime?
  convertedToBookingId String?
  notes             String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([email])
  @@index([status])
  @@index([createdAt])
  @@map("inquiries")
}

// A caregiver can be a User with CAREGIVER role
// This stores additional caregiver-specific information
model CaregiverProfile {
  id                String   @id @default(cuid())
  userId            String   @unique
  licenseNumber     String?
  specialization    String[] // e.g., ["elderly care", "pediatric"]
  yearsOfExperience Int?
  bio               String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("caregiver_profiles")
}

// Patient is a separate entity, not a User
// Patients have health data and can be assigned caregivers
// Patients are associated with user-clients as family members
model Patient {
  id                String    @id @default(cuid())
  firstName         String
  lastName          String
  email             String?   @unique
  phone             String?
  image             String?
  dateOfBirth       DateTime?
  biologicalGender  String?
  heightCm          Float?
  weightKg          Float?
  timezone          String?
  medicalConditions String[]
  medications       Json? // Array of {name, dosage, frequency}
  emergencyContact  String?
  emergencyPhone    String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Family member relationships - connects to user-clients
  familyMembers FamilyMemberAssignment[]

  // Caregiver assignments
  caregivers PatientCaregiverAssignment[] @relation("PatientToCaregiver")

  // Health data
  vitals              Vitals[]
  dailyLogs           DailyLog[]
  labResults          LabResults[]
  medicalAppointments MedicalAppointment[]
  bookings            Booking[]
  files               File[]

  @@map("patients")
}

// Family member relationship - connects patients to user-clients
// Allows clients to have access to patients as family members
model FamilyMemberAssignment {
  id               String      @id @default(cuid())
  patientId        String
  clientId         String // Must be a User with CLIENT role
  relationshipType String // "parent", "sibling", "spouse", "child", "guardian", etc.
  accessLevel      AccessLevel @default(VIEW) // View-only or edit permissions
  assignedAt       DateTime    @default(now())
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  client  User    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([patientId, clientId])
  @@index([patientId])
  @@index([clientId])
  @@map("family_member_assignments")
}

// This model connects caregivers to patients (many-to-many)
model PatientCaregiverAssignment {
  id           String    @id @default(cuid())
  patientId    String
  caregiverId  String
  assignedAt   DateTime  @default(now())
  unassignedAt DateTime?
  notes        String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  patient   Patient @relation("PatientToCaregiver", fields: [patientId], references: [id], onDelete: Cascade)
  caregiver User    @relation("CaregiverToPatient", fields: [caregiverId], references: [id], onDelete: Cascade)

  @@unique([patientId, caregiverId])
  @@index([patientId])
  @@index([caregiverId])
  @@map("patient_caregiver_assignments")
}

// DEPRECATED: UserProfile is no longer used
// Health data is now stored in the Patient model
// Use Patient model for all health-related data and FamilyMemberAssignment for client-patient relationships
// model UserProfile {
//   id                    String    @id @default(cuid())
//   userId                String    @unique
//   name                  String?
//   age                   Int?
//   biologicalGender      String?
//   heightCm              Float?
//   weightKg              Float?
//   timezone              String?
//   medicalConditions     String[]
//   medications           Json?     // Array of {name, dosage, frequency}
//   primaryCaregiverProvider String?
//   createdAt             DateTime  @default(now())
//   updatedAt             DateTime  @updatedAt
//   user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
//
//   @@map("user_profiles")
// }

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Booking {
  id               String        @id @default(cuid())
  calcomId         String        @unique
  userId           String
  serviceId        String?
  patientId        String?
  calendlyEventId  String?
  scheduledAt      DateTime
  timezone         String?
  status           BookingStatus @default(SCHEDULED)
  intakeForm       Json?
  notes            String?
  clientName       String
  clientEmail      String
  clientPhone      String?
  eventTitle       String?
  note             String?
  meetingUri       String?
  intakeFormData   Json?
  confirmationSent Boolean       @default(false)
  reminderSent     Boolean       @default(false)
  thankYouSent     Boolean       @default(false)
  followUpSent     Boolean       @default(false)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  cancelledAt      DateTime?
  rescheduledFrom  String?

  // Pipeline tracking
  inquirySource    String?       // Source of initial inquiry
  proposalSentAt   DateTime?
  pipelineStageHistory Json?     // JSON array tracking stage transitions: [{stage, timestamp, notes}]

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  service   Service?   @relation(fields: [serviceId], references: [id])
  patient   Patient?   @relation(fields: [patientId], references: [id])
  payment   Payment?
  invoice   Invoice?
  reminders Reminder[]
  proposal  Proposal?

  @@index([clientEmail])
  @@index([scheduledAt])
  @@index([status])
  @@map("bookings")
}

model Vitals {
  id            String   @id @default(cuid())
  patientId     String
  temperature   Float
  bloodPressure String
  heartRate     Int
  recordedAt    DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  patient       Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([recordedAt])
  @@map("vitals")
}

model DailyLog {
  id                    String                 @id @default(cuid())
  patientId             String
  date                  DateTime
  sleepData             SleepLog?
  morningVitals         MorningVitals?
  eveningVitals         EveningVitals?
  physicalActivity      PhysicalActivity?
  nutritionData         Nutrition?
  mentalHealthData      MentalHealth?
  cognitivePerformance  CognitivePerformance?
  environmentalExposure EnvironmentalExposure?
  womenHealth           WomenHealth?
  glucoseMonitoring     GlucoseMonitoring?
  medicationAdherence   Json?
  hygieneSelfcare       Json?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  patient               Patient                @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@unique([patientId, date])
  @@index([patientId])
  @@index([date])
  @@map("daily_logs")
}

model File {
  id           String   @id @default(cuid())
  filename     String
  originalName String
  mimeType     String
  size         Int
  url          String
  patientId    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  patient      Patient? @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@map("files")
}


model SleepLog {
  id                      String   @id @default(cuid())
  dailyLogId              String   @unique
  bedtime                 DateTime
  wakeTime                DateTime
  totalSleepMinutes       Int
  awakeMinutes            Int?
  lightSleepMinutes       Int?
  deepSleepMinutes        Int?
  remSleepMinutes         Int?
  sleepScore              Int?
  interruptions           Int?
  avgHeartRateDuringSleep Float?
  lowestHeartRate         Int?
  highestHeartRate        Int?
  respiratoryRateAvg      Float?
  bloodOxygenAvg          Float?
  roomTemperature         Float?
  noiseLevel              String?
  lightExposure           String?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  dailyLog                DailyLog @relation(fields: [dailyLogId], references: [id], onDelete: Cascade)

  @@map("sleep_logs")
}

model MorningVitals {
  id                   String   @id @default(cuid())
  dailyLogId           String   @unique
  timestamp            DateTime
  systolic             Int
  diastolic            Int
  pulse                Int
  temperatureCelsius   Float
  weightKg             Float?
  restingHeartRate     Int?
  heartRateVariability Int?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  dailyLog             DailyLog @relation(fields: [dailyLogId], references: [id], onDelete: Cascade)

  @@map("morning_vitals")
}

model EveningVitals {
  id                 String   @id @default(cuid())
  dailyLogId         String   @unique
  timestamp          DateTime
  systolic           Int
  diastolic          Int
  pulse              Int
  temperatureCelsius Float
  weightKg           Float?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  dailyLog           DailyLog @relation(fields: [dailyLogId], references: [id], onDelete: Cascade)

  @@map("evening_vitals")
}

model PhysicalActivity {
  id               String    @id @default(cuid())
  dailyLogId       String    @unique
  steps            Int?
  distanceKm       Float?
  activeMinutes    Int?
  caloriesBurned   Float?
  floorsClimbed    Int?
  sedentaryMinutes Int?
  standingMinutes  Int?
  workouts         Workout[]
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  dailyLog         DailyLog  @relation(fields: [dailyLogId], references: [id], onDelete: Cascade)

  @@map("physical_activities")
}

model Workout {
  id                    String           @id @default(cuid())
  physicalActivityId    String
  type                  String
  startTime             DateTime
  durationMinutes       Int
  distanceKm            Float?
  calories              Float?
  heartRateZone1Minutes Int?
  heartRateZone2Minutes Int?
  heartRateZone3Minutes Int?
  heartRateZone4Minutes Int?
  heartRateZone5Minutes Int?
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  physicalActivity      PhysicalActivity @relation(fields: [physicalActivityId], references: [id], onDelete: Cascade)

  @@map("workouts")
}

model Nutrition {
  id            String   @id @default(cuid())
  dailyLogId    String   @unique
  totalCalories Float
  totalProteinG Float
  totalCarbsG   Float
  totalFatG     Float
  totalFiberG   Float
  totalSugarG   Float
  totalSodiumMg Int?
  totalWaterMl  Float?
  meals         Meal[]
  supplements   Json? // Array of {name, dosage, time}
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  dailyLog      DailyLog @relation(fields: [dailyLogId], references: [id], onDelete: Cascade)

  @@map("nutrition")
}

model Meal {
  id          String    @id @default(cuid())
  nutritionId String
  mealType    String // breakfast, lunch, dinner, snack
  mealTime    DateTime
  foods       Json // Array of {name, calories, macros, micronutrients}
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  nutrition   Nutrition @relation(fields: [nutritionId], references: [id], onDelete: Cascade)

  @@map("meals")
}

model MentalHealth {
  id                      String    @id @default(cuid())
  dailyLogId              String    @unique
  moodRatings             Json // Array of {time, overall_mood, energy_level, stress_level, anxiety_level, notes}
  meditationSessions      Int?
  meditationTotalMin      Int?
  meditationType          String?
  meditationTime          DateTime?
  gratitudeJournal        String[]
  qualityTimeSocialMin    Int?
  meaningfulConversations Int?
  socialEnergyLevel       Int?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  dailyLog                DailyLog  @relation(fields: [dailyLogId], references: [id], onDelete: Cascade)

  @@map("mental_health")
}

model CognitivePerformance {
  id                     String   @id @default(cuid())
  dailyLogId             String   @unique
  focusSessions          Json? // Array of {start_time, duration_minutes, task_type, productivity_rating, interruptions}
  brainTrainingCompleted Boolean?
  gamesPlayed            Json? // Array of game names
  averageScore           Int?
  reactionTimeMs         Int?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  dailyLog               DailyLog @relation(fields: [dailyLogId], references: [id], onDelete: Cascade)

  @@map("cognitive_performance")
}

model EnvironmentalExposure {
  id                       String   @id @default(cuid())
  dailyLogId               String   @unique
  totalScreenMinutes       Int?
  workScreenMinutes        Int?
  leisureScreenMinutes     Int?
  blueLightEveningExposure String?
  outdoorTimeMinutes       Int?
  sunlightExposureMin      Int?
  airQualityIndex          Int?
  uvExposureIndex          Int?
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
  dailyLog                 DailyLog @relation(fields: [dailyLogId], references: [id], onDelete: Cascade)

  @@map("environmental_exposure")
}

model WomenHealth {
  id                   String   @id @default(cuid())
  dailyLogId           String   @unique
  menstrualCycleDay    Int?
  cyclePhase           String?
  symptoms             Json? // Array of symptom strings
  basalBodyTemperature Float?
  cervicalMucus        String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  dailyLog             DailyLog @relation(fields: [dailyLogId], references: [id], onDelete: Cascade)

  @@map("women_health")
}

model GlucoseMonitoring {
  id                 String   @id @default(cuid())
  dailyLogId         String   @unique
  fastingGlucoseMgDl Int?
  averageGlucoseMgDl Int?
  timeInRangePercent Int?
  postMealReadings   Json? // Array of {time, reading_mg_dl, meal_context}
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  dailyLog           DailyLog @relation(fields: [dailyLogId], references: [id], onDelete: Cascade)

  @@map("glucose_monitoring")
}

model MedicalAppointment {
  id                 String   @id @default(cuid())
  patientId          String
  date               DateTime
  provider           String
  reason             String
  pulse              Int?
  systolic           Int?
  diastolic          Int?
  weightKg           Float?
  temperatureCelsius Float?
  labOrders          Json? // Array of lab test names
  notes              String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  patient            Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([date])
  @@map("medical_appointments")
}

model LabResults {
  id          String   @id @default(cuid())
  patientId   String
  date        DateTime
  testResults Json // Array of {name, value, unit, reference_range, status}
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([date])
  @@map("lab_results")
}

model Service {
  id            String    @id @default(cuid())
  title         String
  slug          String    @unique
  description   String?
  basePrice     Float?
  currency      String    @default("NGN")
  isActive      Boolean   @default(true)
  pricingConfig Json? // {discountPercentage, minPrice, maxPrice, pricingNotes, enableForPayments}
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  bookings      Booking[]

  @@map("services")
}

// Proposal model tracks proposal/quote stage in the sales pipeline
model Proposal {
  id               String          @id @default(cuid())
  bookingId        String          @unique
  status           ProposalStatus  @default(DRAFT)
  title            String?         // Proposal title/name
  description      String?         // Proposal description
  servicesOffered  Json?           // Array of {serviceId, title, price, description}
  totalAmount      Float?
  currency         String          @default("NGN")
  validUntil       DateTime?
  sentAt           DateTime?
  viewedAt         DateTime?
  acceptedAt       DateTime?
  rejectedAt       DateTime?
  rejectionReason  String?
  notes            String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  booking          Booking         @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([status])
  @@index([sentAt])
  @@map("proposals")
}

model Payment {
  id          String        @id @default(cuid())
  bookingId   String        @unique
  amount      Float
  status      PaymentStatus @default(PENDING)
  providerRef String?       @unique
  paidAt      DateTime      @default(now())
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  booking     Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model Invoice {
  id        String   @id @default(cuid())
  bookingId String   @unique
  amount    Float
  currency  String?
  status    String   @default("PENDING")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("invoices")
}

model Reminder {
  id          String         @id @default(cuid())
  bookingId   String
  type        String
  scheduledAt DateTime
  status      ReminderStatus @default(PENDING)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  booking     Booking        @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@map("reminders")
}

model AdminSignupCode {
  id        String    @id @default(cuid())
  code      String    @unique
  createdAt DateTime  @default(now())
  expiresAt DateTime
  isUsed    Boolean   @default(false)
  usedBy    String?
  usedAt    DateTime?
  createdBy String // Admin who created the code

  @@index([isUsed])
  @@index([expiresAt])
  @@map("admin_signup_codes")
}

model LandingPagePopup {
  id              String   @id @default(cuid())
  title           String
  description     String?
  imageUrl        String?
  imageAlt        String?
  actionButtonText String
  actionButtonUrl String
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([isActive])
  @@map("landing_page_popups")
}

enum Role {
  ADMIN
  CAREGIVER
  CLIENT
}

enum AccessLevel {
  VIEW
  EDIT
  FULL_ACCESS
}

enum PaymentStatus {
  FREE
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum BookingStatus {
  SCHEDULED
  PROPOSAL
  RESCHEDULED
  CANCELLED
  COMPLETED
  NO_SHOW
}

enum ReminderStatus {
  PENDING
  SENT
  FAILED
  CANCELLED
}

// Customer conversion pipeline stages
enum ClientConversionStage {
  PROSPECT      // Initial visitor/contact
  INQUIRY       // Inquiry submitted
  CONSULTATION_BOOKED // Booking created for consultation
  PROPOSAL_SENT // Proposal sent to client
  CLIENT        // Became paying client
}

// Inquiry status tracking
enum InquiryStatus {
  NEW           // Newly submitted inquiry
  QUALIFIED     // Qualified as potential client
  DISQUALIFIED  // Not a good fit
  CONVERTED     // Converted to booking/consultation
}

// Proposal status tracking in the sales pipeline
enum ProposalStatus {
  DRAFT         // Proposal being prepared
  SENT          // Proposal sent to client
  VIEWED        // Client has viewed the proposal
  ACCEPTED      // Client accepted the proposal
  REJECTED      // Client rejected the proposal
}
