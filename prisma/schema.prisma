generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String    @id @default(cuid())
  name                  String?
  email                 String?   @unique
  emailVerified         DateTime?
  password              String?
  image                 String? 
  phone                 String?
  role                  Role      @default(CLIENT)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  accounts              Account[]
  sessions              Session[]
  vitals                Vitals[]
  userProfile           UserProfile?
  dailyLogs             DailyLog[]
  labResults            LabResults[]
  medicalAppointments   MedicalAppointment[]
  bookings              Booking[]
  
  // Caregiver relations
  caregiverProfile      CaregiverProfile?
  patientsAsCaregiver   PatientCaregiverAssignment[] @relation("CaregiverToPatient")
  
  // Patient relations
  patientProfile        PatientProfile?
  caregiversForPatient  PatientCaregiverAssignment[] @relation("PatientToCaregiver")
  usersAssignedToPatient UserPatientAssignment[]

  @@map("users")
}

// A caregiver can be a User with CAREGIVER role
// This stores additional caregiver-specific information
model CaregiverProfile {
  id                    String    @id @default(cuid())
  userId                String    @unique
  licenseNumber         String?
  specialization        String[]  // e.g., ["elderly care", "pediatric"]
  yearsOfExperience     Int?
  bio                   String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("caregiver_profiles")
}

// A patient can be a User with CLIENT role who receives care
// This stores additional patient-specific information
model PatientProfile {
  id                    String    @id @default(cuid())
  userId                String    @unique
  dateOfBirth           DateTime?
  biologicalGender      String?
  heightCm              Float?
  weightKg              Float?
  timezone              String?
  medicalConditions     String[]
  medications           Json?     // Array of {name, dosage, frequency}
  emergencyContact      String?
  emergencyPhone        String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("patient_profiles")
}

// This model connects caregivers to patients (many-to-many)
model PatientCaregiverAssignment {
  id                    String    @id @default(cuid())
  patientId             String
  caregiverId           String
  assignedAt            DateTime  @default(now())
  unassignedAt          DateTime?
  notes                 String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  patient               User      @relation("PatientToCaregiver", fields: [patientId], references: [id], onDelete: Cascade)
  caregiver             User      @relation("CaregiverToPatient", fields: [caregiverId], references: [id], onDelete: Cascade)

  @@unique([patientId, caregiverId])
  @@index([patientId])
  @@index([caregiverId])
  @@map("patient_caregiver_assignments")
}

// This model connects patients to multiple users (e.g., family members, healthcare providers)
// A patient can have multiple users with access to their health data
model UserPatientAssignment {
  id                    String    @id @default(cuid())
  userId                String
  patientId             String
  relationshipType      String    // "family_member", "healthcare_provider", "emergency_contact"
  accessLevel           AccessLevel @default(VIEW) // View-only or edit permissions
  assignedAt            DateTime  @default(now())
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  // Optionally reference patient via PatientProfile
  // This assumes the patientId refers to a User who has a PatientProfile

  @@unique([userId, patientId])
  @@index([userId])
  @@index([patientId])
  @@map("user_patient_assignments")
}

// Keep UserProfile for additional user metadata if needed
model UserProfile {
  id                    String    @id @default(cuid())
  userId                String    @unique
  name                  String?
  age                   Int?
  biologicalGender      String?
  heightCm              Float?
  weightKg              Float?
  timezone              String?
  medicalConditions     String[]
  medications           Json?     // Array of {name, dosage, frequency}
  primaryCaregiverProvider String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}
 
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Booking {
  id                String        @id @default(cuid())
  calcomId          String        @unique
  userId            String
  serviceId         String?
  patientId         String?
  calendlyEventId   String?
  scheduledAt       DateTime
  timezone          String?
  status            BookingStatus @default(SCHEDULED)
  intakeForm        Json?
  notes             String?
  clientName        String
  clientEmail       String
  clientPhone       String? 
  eventTitle        String?
  note              String? 
  meetingUri        String?
  intakeFormData    Json?
  confirmationSent  Boolean       @default(false)
  reminderSent      Boolean       @default(false)
  thankYouSent      Boolean       @default(false)
  followUpSent      Boolean       @default(false)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  cancelledAt       DateTime?
  rescheduledFrom   String?
  
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  service           Service?      @relation(fields: [serviceId], references: [id])
  patient           Patient?      @relation(fields: [patientId], references: [id])
  payment           Payment?
  invoice           Invoice?
  reminders         Reminder[]

  @@index([clientEmail])
  @@index([scheduledAt])
  @@map("bookings")
}

model Vitals {
  id            String    @id @default(cuid())
  userId        String
  temperature   Float
  bloodPressure String
  heartRate     Int
  recordedAt    DateTime  @default(now())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([recordedAt])
  @@map("vitals")
}

model DailyLog {
  id                    String    @id @default(cuid())
  userId                String
  date                  DateTime
  sleepData             SleepLog?
  morningVitals         MorningVitals?
  eveningVitals         EveningVitals?
  physicalActivity      PhysicalActivity?
  nutritionData         Nutrition?
  mentalHealthData      MentalHealth?
  cognitivePerformance  CognitivePerformance?
  environmentalExposure EnvironmentalExposure?
  womenHealth           WomenHealth?
  glucoseMonitoring     GlucoseMonitoring?
  medicationAdherence   Json?
  hygieneSelfcare       Json?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
  @@map("daily_logs")
}

model SleepLog {
  id                    String    @id @default(cuid())
  dailyLogId            String    @unique
  bedtime               DateTime
  wakeTime              DateTime
  totalSleepMinutes     Int
  awakeMinutes          Int?
  lightSleepMinutes     Int?
  deepSleepMinutes      Int?
  remSleepMinutes       Int?
  sleepScore            Int?
  interruptions         Int?
  avgHeartRateDuringSleep Float?
  lowestHeartRate       Int?
  highestHeartRate      Int?
  respiratoryRateAvg    Float?
  bloodOxygenAvg        Float?
  roomTemperature       Float?
  noiseLevel            String?
  lightExposure         String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  dailyLog              DailyLog  @relation(fields: [dailyLogId], references: [id], onDelete: Cascade)

  @@map("sleep_logs")
}

model MorningVitals {
  id                    String    @id @default(cuid())
  dailyLogId            String    @unique
  timestamp             DateTime
  systolic              Int
  diastolic             Int
  pulse                 Int
  temperatureCelsius    Float
  weightKg              Float?
  restingHeartRate      Int?
  heartRateVariability  Int?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  dailyLog              DailyLog  @relation(fields: [dailyLogId], references: [id], onDelete: Cascade)

  @@map("morning_vitals")
}

model EveningVitals {
  id                    String    @id @default(cuid())
  dailyLogId            String    @unique
  timestamp             DateTime
  systolic              Int
  diastolic             Int
  pulse                 Int
  temperatureCelsius    Float
  weightKg              Float?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  dailyLog              DailyLog  @relation(fields: [dailyLogId], references: [id], onDelete: Cascade)

  @@map("evening_vitals")
}

model PhysicalActivity {
  id                    String    @id @default(cuid())
  dailyLogId            String    @unique
  steps                 Int?
  distanceKm            Float?
  activeMinutes         Int?
  caloriesBurned        Float?
  floorsClimbed         Int?
  sedentaryMinutes      Int?
  standingMinutes       Int?
  workouts              Workout[]
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  dailyLog              DailyLog  @relation(fields: [dailyLogId], references: [id], onDelete: Cascade)

  @@map("physical_activities")
}

model Workout {
  id                    String    @id @default(cuid())
  physicalActivityId    String
  type                  String
  startTime             DateTime
  durationMinutes       Int
  distanceKm            Float?
  calories              Float?
  heartRateZone1Minutes Int?
  heartRateZone2Minutes Int?
  heartRateZone3Minutes Int?
  heartRateZone4Minutes Int?
  heartRateZone5Minutes Int?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  physicalActivity      PhysicalActivity @relation(fields: [physicalActivityId], references: [id], onDelete: Cascade)

  @@map("workouts")
}

model Nutrition {
  id                    String    @id @default(cuid())
  dailyLogId            String    @unique
  totalCalories         Float
  totalProteinG         Float
  totalCarbsG           Float
  totalFatG             Float
  totalFiberG           Float
  totalSugarG           Float
  totalSodiumMg         Int?
  totalWaterMl          Float?
  meals                 Meal[]
  supplements           Json?     // Array of {name, dosage, time}
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  dailyLog              DailyLog  @relation(fields: [dailyLogId], references: [id], onDelete: Cascade)

  @@map("nutrition")
}

model Meal {
  id                    String    @id @default(cuid())
  nutritionId           String
  mealType              String    // breakfast, lunch, dinner, snack
  mealTime              DateTime
  foods                 Json      // Array of {name, calories, macros, micronutrients}
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  nutrition             Nutrition @relation(fields: [nutritionId], references: [id], onDelete: Cascade)

  @@map("meals")
}

model MentalHealth {
  id                    String    @id @default(cuid())
  dailyLogId            String    @unique
  moodRatings           Json      // Array of {time, overall_mood, energy_level, stress_level, anxiety_level, notes}
  meditationSessions    Int?
  meditationTotalMin    Int?
  meditationType        String?
  meditationTime        DateTime?
  gratitudeJournal      String[]
  qualityTimeSocialMin  Int?
  meaningfulConversations Int?
  socialEnergyLevel     Int?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  dailyLog              DailyLog  @relation(fields: [dailyLogId], references: [id], onDelete: Cascade)

  @@map("mental_health")
}

model CognitivePerformance {
  id                    String    @id @default(cuid())
  dailyLogId            String    @unique
  focusSessions         Json?     // Array of {start_time, duration_minutes, task_type, productivity_rating, interruptions}
  brainTrainingCompleted Boolean?
  gamesPlayed           Json?     // Array of game names
  averageScore          Int?
  reactionTimeMs        Int?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  dailyLog              DailyLog  @relation(fields: [dailyLogId], references: [id], onDelete: Cascade)

  @@map("cognitive_performance")
}

model EnvironmentalExposure {
  id                    String    @id @default(cuid())
  dailyLogId            String    @unique
  totalScreenMinutes    Int?
  workScreenMinutes     Int?
  leisureScreenMinutes  Int?
  blueLightEveningExposure String?
  outdoorTimeMinutes    Int?
  sunlightExposureMin   Int?
  airQualityIndex       Int?
  uvExposureIndex       Int?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  dailyLog              DailyLog  @relation(fields: [dailyLogId], references: [id], onDelete: Cascade)

  @@map("environmental_exposure")
}

model WomenHealth {
  id                    String    @id @default(cuid())
  dailyLogId            String    @unique
  menstrualCycleDay     Int?
  cyclePhase            String?
  symptoms              Json?     // Array of symptom strings
  basalBodyTemperature  Float?
  cervicalMucus         String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  dailyLog              DailyLog  @relation(fields: [dailyLogId], references: [id], onDelete: Cascade)

  @@map("women_health")
}

model GlucoseMonitoring {
  id                    String    @id @default(cuid())
  dailyLogId            String    @unique
  fastingGlucoseMgDl    Int?
  averageGlucoseMgDl    Int?
  timeInRangePercent    Int?
  postMealReadings      Json?     // Array of {time, reading_mg_dl, meal_context}
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  dailyLog              DailyLog  @relation(fields: [dailyLogId], references: [id], onDelete: Cascade)

  @@map("glucose_monitoring")
}

model MedicalAppointment {
  id                    String    @id @default(cuid())
  userId                String
  date                  DateTime
  provider              String
  reason                String
  pulse                 Int?
  systolic              Int?
  diastolic             Int?
  weightKg              Float?
  temperatureCelsius    Float?
  labOrders             Json?     // Array of lab test names
  notes                 String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([date])
  @@map("medical_appointments")
}

model LabResults {
  id                    String    @id @default(cuid())
  userId                String
  date                  DateTime
  testResults           Json      // Array of {name, value, unit, reference_range, status}
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([date])
  @@map("lab_results")
}

model Service {
  id              String   @id @default(cuid())
  title           String
  slug            String   @unique
  description     String?
  basePrice       Float?
  currency        String   @default("NGN")
  isActive        Boolean  @default(true)
  pricingConfig   Json?    // {discountPercentage, minPrice, maxPrice, pricingNotes, enableForPayments}
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  bookings        Booking[]

  @@map("services")
}

model Patient {
  id          String   @id @default(cuid())
  name        String
  email       String?   @unique  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  bookings    Booking[]

  @@map("patients")
}

model Payment {
  id          String   @id @default(cuid())
  bookingId   String   @unique
  amount      Float
  status      PaymentStatus @default(PENDING)
  providerRef  String?  @unique
  paidAt      DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  booking     Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model Invoice {
  id          String   @id @default(cuid())
  bookingId   String   @unique
  amount      Float
  currency    String?
  status      String   @default("PENDING")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  booking     Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("invoices")
}

model Reminder {
  id          String   @id @default(cuid())
  bookingId   String
  type        String
  scheduledAt DateTime
  status      String   @default("PENDING")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  booking     Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@map("reminders")
}

model AdminSignupCode {
  id        String    @id @default(cuid())
  code      String    @unique
  createdAt DateTime  @default(now())
  expiresAt DateTime
  isUsed    Boolean   @default(false)
  usedBy    String?
  usedAt    DateTime?
  createdBy String    // Admin who created the code

  @@index([isUsed])
  @@index([expiresAt])
  @@map("admin_signup_codes")
}

enum Role {
  ADMIN
  CAREGIVER
  CLIENT
}

enum AccessLevel {
  VIEW
  EDIT
  FULL_ACCESS
}

enum PaymentStatus {
  FREE
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum BookingStatus {
  SCHEDULED
  RESCHEDULED
  CANCELLED
  COMPLETED
  NO_SHOW
}